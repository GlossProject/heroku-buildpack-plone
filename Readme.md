Heroku buildpack: Plone
=======================

This is a [Heroku buildpack](http://devcenter.heroku.com/articles/buildpacks) for Plone apps, powered by [zc.buildout](http://www.buildout.org/en/latest/).

Plone on Heroku
---------------

To make Plone run on Heroku you need to add the following configuration to your
``buildout.cfg`` file:

    [buildout]
    ...
    relative-paths = true

    [instance]
    ...
    relative-paths = true
    eggs +=
        ...
        RelStorage
        psycopg2
    rel-storage =
        keep-history false
        blob-dir /tmp/blobcache
        shared-blob-dir false
        type postgresql
        host PG_HOST
        dbname PG_DBNAME
        user PG_USER
        password PG_PASS

A sample minimal ``buildout.cfg`` is provided in this repo, just look above :).

There are two things to you need to know about Heroku to understand the changes
above:

1. Heroku's unit of computation is called a [dyno](https://devcenter.heroku.com/articles/dynos). Think of it as a single server instance.

2. Heroku has a two-step deployment workflow: First you compile a runtime slug (``bin/buildout`` in our case), then Heroku copies this slug to a dyno and runs your app code against the slug (``bin/instance console`` in our case). Because of the fact that ``bin/buildout`` is ran in a different place than ``bin/instance`` we need to fix some paths generated by buildout. We get half-way there with the ``relative-paths`` flag and then use ``sed`` to fix the rest of the paths in ``zope.conf`` that buildout generated for us.

3. At the compile time (``bin/buildout`` in our case) we do not yet know on which port Plone will run -- this is given as an environment variable when running the runtime slug on a dyno. However Plone does not have any way of either using environment variables in ``zope.conf`` or reading command-line parameters when starting up with ``bin/instance``. So we ship a ``configure_zopeconf.py`` script that reads env values and uses search/replace to inject them into ``zope.conf``. We run this script just before starting the Plone instance on the dyno.

4. Lastly, Heroku has ephemeral filesystem, meaning you loose all data when a dyno restarts. Luckly
Heroku provides world-class Postgres-as-a-service persistency option. We just need to configure
Plone to use ``RelStorage`` which gives it support for relational databases. DB connection settings
are set by the ``configure_zopeconf.py`` script, which reads them from environment variables.

5. On free-tier Heroku gives you one dyno instance per month. Forever. However, if there are no requests to your site withing an hour, Heroku will put the dyno to sleep. When the next request comes there will be some delay before a response is sent back (~20s for heroku startup, ~20s for Plone startup), but subsequent requests will be served at a normal speed.

6. The free-tier PostgreSQL DB that you get with this buildpack has a limit of 10.000 rows. To keep clear of this limit the ``buildout.cfg`` above sets the ``keep-history false`` flag to not keep transactional history. This means that you loose the `Undo` feature, but you do keep the document history, your DB remains small and manageable and there is no need to regularly "pack" your DB. The 10k limit is (based on quick tests) reached after about 200 content items. After that you need to move to the first paid PostgreSQL plan ($9/month) which bumps the limit to 10 million rows. To check how many rows you
are using, run ``heroku pg:info``.


Usage
-----

Example usage, assuming you have already [signed up for a Heroku account](https://id.heroku.com/signup) and have successfully installed the [Heroku Toolbelt](https://toolbelt.heroku.com/):

    $ ls
    buildout.cfg

    $ git init
    $ git add buildout.cfg
    $ git commit -m "initial commit"

    $ heroku create --buildpack git://github.com/niteoweb/heroku-buildpack-plone.git

    $ git push heroku master
    ...
    -----> Plone app detected
    -----> Use build cache
           Get buildout results from the previous build
    -----> Bootstrap buildout
           ...
    -----> Run bin/buildout
           ...
    -----> Fix paths in zope.conf
    -----> Copy results to cache
    -----> Copy results to slug
    -----> Copy configure_zopeconf.py script to slug
    -----> Discovering process types
           Procfile declares types    -> (none)
           Default types for Plone -> web

    $ heroku open
    $ heroku logs -t

The buildpack will detect your app as Plone if it has the file `buildout.cfg` in the root. It will use `zc.buildout` to install your dependencies, vendoring a copy of the Plone runtime into your slug. It will define a default ``Procfile`` (so you don't have to manually create it) and provision a free-tier PostgreSQL database for persistence.

At this point you should probably read more about [how Heroku works](https://devcenter.heroku.com/articles/how-heroku-works).


Options
-------

### Running an arbitrary *.cfg file

To run an arbitrary *.cfg file, (like ``heroku.cfg`` for example) set the following environment variable:

    $ heroku config:add BUILDOUT_CFG=heroku.cfg

### Increase buildout verbosity

To increase the verbosity of ``bin/buildout`` set the following environment variable:

    $ heroku config:add BUILDOUT_VERBOSITY=-v

You can increase verbosity up to ``-vvvv``.


Migrating an existing Plone site to Heroku
------------------------------------------

When moving to Heroku the main task is to migrate from ZODB filesystem type database to PostgreSQL relational database. Every migration will differ but this are the general steps that you should take:

1. download Data.fs & BLOBs to local machine
2. modify local buildout.cfg with heroku specific configuration
3. git push to heroku to confirm you site runs on Heroku and that a PostgreSQL database is created
4. $ heroku config -> write down the DB connection string
5. follow instructions on https://pypi.python.org/pypi/RelStorage#id18, an example ``zodbconvert.conf`` follows:

    <filestorage source>
      path var/filestorage/Data.fs
      blob-dir var/blobstorage
    </filestorage>

    <relstorage destination>
      shared-blob-dir false
      blob-dir ./var/blobcache
      blob-cache-size 10mb
      keep-history false
        <postgresql>
          dsn dbname='<DATABASE>' user='<USER>' host='<HOST>' password='PASSWOR'
        </postgresql>
    </relstorage>


:sparkles: Bonus Karma Points :sparkles:
-----------------------------------------

Below is a few more tips n' tricks on how to get the most out of the Heroku environment.

### DNS & Cloudflare

By default, your app will be available on ``<APP_NAME>.herokuapp.com`` but you can use a custom domain even on the free tier.

    $ heroku domains:add www.mydomain.com

Then create a `CNAME` record that points to ``<APP_NAME>.herokuapp.com``. More info on https://devcenter.heroku.com/articles/custom-domains.

It's recommended to use [Cloudflare](http://cloudflare.com/) as a DNS provider. Their free-tier plan acts as a simple [CDN](https://en.wikipedia.org/wiki/Content_delivery_network), while their [AlwaysOnline](https://support.cloudflare.com/hc/en-us/articles/200168006-What-does-Always-Online-do-) feature helps when your free dyno [goes to sleep](https://devcenter.heroku.com/articles/dynos#dyno-sleeping).

### Virtual Hosting

By default, your Plone site will be available at ``<DOMAIN>/Plone``. But normally, you would want to have your Plone site served at root (``/``). No worries, Zope's Virtual Hosting Monster to the rescue!

Go to ``<DOMAIN>/Plone/virtual_hosting/manage_edit`` and add the following entry: ``<DOMAIN>/Plone``. Click ``Save Changes`` and reload.

### Sending emails

The Heroku dyno does not have ``sendmail`` installed. Even if it did, it is not recommended to send out emails from an unknown server/ip if you want them to be delivered. Instead use the [Mailgun add-on](https://addons.heroku.com/mailgun) that gives you a free SMTP server for outgoing email, along with tracking delivery/open rates.

    $ heroku addons:add mailgun

Now go to MailGun control-panel and add & configure a domain for your app.
Optionally, you can enable tracking of email delivery & clicks.

After your domain is ready, go to ``/@@mail-controlpanel`` on your Plone site and enter hostname/credentials from Mailgun.


### Log archival

Heroku stores [1500 most recent logs entries](https://devcenter.heroku.com/articles/logging#log-history-limits) which you can browse through with the ``heroko logs`` command. To keep a longer history of logs use a free-tier level of the [Papertrail add-on](https://addons.heroku.com/papertrail): this will give you 7 days of searchable log history plus the ability to store unlimited daily archives to your personal Amazon S3 account.

    $ heroku addons:add papertrail

### Database backups

To allow its users a good night's sleep, Heroku offers [daily backups](https://devcenter.heroku.com/articles/pgbackups). Let's enable them.

    $ heroku addons:add pgbackups:auto-month

For extra-paranoid, you can also do [offsite backups to an S3 account](https://github.com/kbaum/pgbackups-archive-app).


### More Heroku add-ons

Browse through all [available add-ons](https://addons.heroku.com/) and see if any of them catches your attention.


Found this repo helpful? Consider "flattring" me!

[![Flattr this git repo](http://api.flattr.com/button/flattr-badge-large.png)](https://flattr.com/submit/auto?user_id=zupo&url=https://github.com/niteoweb/heroku-buildpack-plone&title=heroku-buildpack-plone&language=&tags=github&category=software)


TODO
----

* tests
* automatic deployment of a test app (via travis)
